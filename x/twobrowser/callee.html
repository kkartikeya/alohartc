<!--

The callee accepts an RTCPeerConnection and sends video to the caller.

Copyright (C) 2019 Chris Hiszpanski

-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Callee</title>
    <meta charset="utf-8">
  </head>
  <body>
    <h1>Callee</h1>

    <audio id="remoteAudio" autoplay></audio>

    <p>1. Paste SDP offer from caller here:</p>
    <textarea cols="80" rows="24" id="sdpOffer"></textarea>

    <p>2. Copy this SDP answer to caller:</p>
    <textarea cols="80" rows="24" id="sdpAnswer"></textarea>

    <p>3. Paste remote ICE candidates from caller here:</p>
    <textarea cols="80" rows="24" id="remoteIceCandidates"></textarea>

    <p>4. Copy following local ICE candidates to caller:</p>
    <textarea cols="80" rows="24" id="localIceCandidates"></textarea>

    <script src="js/adapter-latest.js"></script>
    <script>
      'use strict';

      document.getElementById('sdpOffer').addEventListener('paste', handleSdpOffer)
      document.getElementById('remoteIceCandidates').addEventListener('paste', handleRemoteIceCandidates)
  
      let localStream;
      let pc;

      window.onload = callee;

      function trace(arg) {
        var now = (window.performance.now() / 1000).toFixed(3);
        console.log(now + ': ', arg);
      }

      // Handle pasted data
      function handleSdpOffer(e) {
        var clipboardData, pastedData;

        clipboardData = e.clipboardData || window.clipboardData;
        pastedData = clipboardData.getData('Text');

        let json = JSON.parse(pastedData)

        // Use received SDP to set remote description
        pc.setRemoteDescription(json).then(
          onSetRemoteSuccess,
          onSetSessionDescriptionError
        );

        // Create answer
        pc.createAnswer().then(
          onCreateAnswerSuccess,
          onCreateSessionDescriptionError
        );
      }

      function handleRemoteIceCandidates(e) {
        var clipboardData, pastedData;

        clipboardData = e.clipboardData || window.clipboardData;
        pastedData = clipboardData.getData('Text');

        pastedData.split('\n').forEach(function(candidate) {
          if (candidate.length > 1) {
            var c = JSON.parse(candidate)
            pc.addIceCandidate(c).then(() => onAddIceCandidateSuccess(pc), err => onAddIceCandidateError(pc, err));
          }
        });
      }

      function onAddIceCandidateSuccess(pc) {
        trace(`addIceCandidate success`);
      }

      function onAddIceCandidateError(pc, error) {
        trace(`failed to add ICE Candidate: ${error.toString()}`);
      }

      function onSetLocalSuccess(pc) {
        trace(`setLocalDescription complete`);
      }

      function onCreateSessionDescriptionError(error) {
        trace(`Failed to create session description: ${error.toString()}`);
      }

      function onCreateAnswerSuccess(desc) {
        trace(`Answer from pc2:\n${desc.sdp}`);
        document.getElementById("sdpAnswer").value += JSON.stringify(desc);
        trace('setLocalDescription start');
        pc.setLocalDescription(desc).then(
          onSetLocalSuccess,
          onSetSessionDescriptionError
        );
      }

      function onSetRemoteSuccess() {
        trace(`setRemoteDescription complete`);
      }

      function onSetSessionDescriptionError(error) {
        trace(`Failed to set session description: ${error.toString()}`);
      }

      function callee() {
        pc = new RTCPeerConnection();

        // Start user media
        navigator.mediaDevices.getUserMedia({ audio: true, video: true })
          .then(gotUserMedia)
          .catch(e => alert(`getUserMedia() error: ${e.name}`));

        // Register callbacks
        pc.onicecandidate = e => onIceCandidate(pc, e);
        pc.oniceconnectionstatechange = e => onIceStateChange(pc, e);
        pc.ontrack = e => onTrack(pc, e);
      }

      function gotUserMedia(stream) {
        localStream = stream;

        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      }

      function onIceCandidate(pc, event) {
        if (event.candidate) {
          document.getElementById("localIceCandidates").value += JSON.stringify(event.candidate) + '\n';
        }
      }

      function onIceStateChange(pc, event) {
        if (pc) {
          console.log('ICE state change event: ', event);
        }
      }

      function onTrack(pc, event) {
        if (remoteAudio.srcObject !== event.streams[0]) {
          remoteAudio.srcObject = event.streams[0];
          trace('received remote stream');
        }
      }

    </script>
  </body>
</html>
