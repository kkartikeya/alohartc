<!--

The caller initiates an RTCPeerConnection and receives video from the callee.

Copyright (C) 2019 Chris Hiszpanski

-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Caller</title>
    <meta charset="utf-8">
    <style>
      video {
        background: #222;
        margin: 0 0 20px 0;
        width: 640px;
        height: 480px;
      }
    </style>
  </head>
  <body>
    <h1>Caller</h1>

    <video id="remoteVideo" autoplay controls></video>

    <p>1. Copy following SDP offer to the callee:</p>
    <textarea cols="80" rows="24" id="sdpOffer"></textarea>

    <p>2. Paste SDP answer from callee here:</p>
    <textarea cols="80" rows="24" id="sdpAnswer"></textarea>

    <p>3. Copy local ICE candidates to callee:</p>
    <textarea cols="80" rows="24" id="localIceCandidates"></textarea>

    <p>4. Paste remote ICE candidates from callee:</p>
    <textarea cols="80" rows="24" id="remoteIceCandidates"></textarea>

    <script src="js/adapter-latest.js"></script>
    <script>
      'use strict';

      document.getElementById('sdpAnswer').addEventListener('paste', handleSdpAnswer);
      document.getElementById('remoteIceCandidates').addEventListener('paste', handleRemoteIceCandidates);
  
      const remoteVideo = document.getElementById("remoteVideo")
  
      let pc;

      const offerOptions = {
        offerToReceiveAudio: true,
        offerToReceiveVideo: true
      };

      // Local media constraints: audio-only
      const mediaConstraints = {
        audio: true,
        video: false
      };

      window.onload = caller;

      // Handle pasted SDP data
      function handleSdpAnswer(e) {
        var clipboardData, pastedData;

        clipboardData = e.clipboardData || window.clipboardData;
        pastedData = clipboardData.getData('Text');

        let json = JSON.parse(pastedData)
        console.log("received sdp: ", json);

        // Use received SDP to set remote description
        pc.setRemoteDescription(json).then(
          onSetRemoteSuccess,
          onSetSessionDescriptionError
        );
      }

      // Handle pasted ICE data
      function handleRemoteIceCandidates(e) {
        var clipboardData, pastedData;

        clipboardData = e.clipboardData || window.clipboardData;
        pastedData = clipboardData.getData('Text');

        pastedData.split('\n').forEach(function(candidate) {
          if (candidate.length > 1) {
            var c = JSON.parse(candidate)
            pc.addIceCandidate(c).then(() => onAddIceCandidateSuccess(pc), err => onAddIceCandidateError(pc, err));
          }
        });
      }

      function onAddIceCandidateSuccess(pc) {
        trace(`addIceCandidate success`);
      }

      function onAddIceCandidateError(pc, error) {
        trace(`failed to add ICE Candidate: ${error.toString()}`);
      }

      function onSetRemoteSuccess(pc) {
        trace(`setRemoteDescription complete`);
      }

      function trace(arg) {
        var now = (window.performance.now() / 1000).toFixed(3);
        console.log(now + ': ', arg);
      }

      function caller() {
        // Create a new peer connection
        pc = new RTCPeerConnection();

        // Register callbacks
        pc.onicecandidate = e => onIceCandidate(pc, e);
        pc.oniceconnectionstatechange = e => onIceStateChange(pc, e);
        pc.ontrack = gotRemoteStream;

        // Get local audio
        navigator.mediaDevices.getUserMedia(mediaConstraints).then(function(stream) {
          // Add local audio track to peer connection
          stream.getAudioTracks().forEach(track => pc.addTrack(track, stream));

          // Create offer with local audio source
          pc.createOffer(offerOptions).then(
            onCreateOfferSuccess,
            onCreateSessionDescriptionError
          );
        }).catch(function(error) {
          console.log("getUserMedia: ", error.message, error.name);
        });
      }

      function onCreateOfferSuccess(desc) {
        trace(`Offer: ${desc.sdp}`);
        trace('setLocalDescription start');
        document.getElementById("sdpOffer").value += JSON.stringify(desc);
        pc.setLocalDescription(desc).then(
          () => onSetLocalSuccess(pc),
          onSetSessionDescriptionError
        );
      }

      function onCreateSessionDescriptionError(error) {
        trace(`Failed to create session description: ${error.toString()}`);
      }

      function onSetLocalSuccess(pc) {
        trace(`setLocalDescription complete`);
      }

      function onSetSessionDescriptionError(error) {
        trace(`Failed to set session description: ${error.toString()}`);
      }

      function onIceCandidate(pc, event) {
        console.log(event.candidate);
        trace(`ICE candidate:\n${event.candidate ? event.candidate.candidate : '(null)'}`);
        if (event.candidate) {
          document.getElementById("localIceCandidates").value += JSON.stringify(event.candidate) + '\n';
        }
      }

      function onIceStateChange(pc, event) {
        if (pc) {
          trace(`ICE state: ${pc.iceConnectionState}`);
          console.log('ICE state change event: ', event);
        }
      }

      function gotRemoteStream(e) {
        if (remoteVideo.srcObject !== e.streams[0]) {
          remoteVideo.srcObject = e.streams[0];
          trace('received remote stream');
        }
      }

      function onAddIceCandidateSuccess(pc) {
        trace(`addIceCandidate success`);
      }

      function onAddIceCandidateError(pc, error) {
        trace(`Failed to add ICE Candidate: ${error.toString()}`);
      }

    </script>
  </body>
</html>
